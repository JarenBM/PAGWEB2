<!-- PAGWEB2/test-fix.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Reparaci√≥n RLS</title>
  </head>
  <body>
    <h1>Test Reparaci√≥n RLS</h1>
    <div id="result"></div>

    <script type="module">
      import { supabase } from "./js/supabaseClient.js";

      async function testFix() {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "<p>üîÑ Probando reparaci√≥n...</p>";

        try {
          // 1. Test productos (deber√≠a funcionar sin auth)
          const { data: products, error: pError } = await supabase
            .from("products")
            .select("id, name")
            .limit(2);

          if (pError) {
            resultDiv.innerHTML += `<p style="color: red;">‚ùå Productos: ${pError.message}</p>`;
          } else {
            resultDiv.innerHTML += `<p style="color: green;">‚úÖ Productos: ${
              products?.length || 0
            } encontrados</p>`;
          }

          // 2. Test categor√≠as
          const { data: categories, error: cError } = await supabase
            .from("categories")
            .select("id, name");

          if (cError) {
            resultDiv.innerHTML += `<p style="color: red;">‚ùå Categor√≠as: ${cError.message}</p>`;
          } else {
            resultDiv.innerHTML += `<p style="color: green;">‚úÖ Categor√≠as: ${
              categories?.length || 0
            } encontradas</p>`;
          }

          // 3. Test user_roles (requiere auth)
          const { data: roles, error: rError } = await supabase
            .from("user_roles")
            .select("user_id, role")
            .limit(2);

          if (rError) {
            resultDiv.innerHTML += `<p style="color: orange;">‚ö†Ô∏è User Roles: ${rError.message} (esperado sin auth)</p>`;
          } else {
            resultDiv.innerHTML += `<p style="color: green;">‚úÖ User Roles: ${
              roles?.length || 0
            } encontrados</p>`;
          }

          // 4. Test simple insert (solo para verificar permisos)
          const { error: testError } = await supabase
            .from("products")
            .select("count", { count: "exact", head: true });

          if (testError) {
            resultDiv.innerHTML += `<p style="color: red;">‚ùå Count test: ${testError.message}</p>`;
          } else {
            resultDiv.innerHTML += `<p style="color: green;">‚úÖ Count test: OK</p>`;
          }

          resultDiv.innerHTML +=
            '<p style="color: blue;">üéØ Si ves productos y categor√≠as OK, el problema est√° resuelto</p>';
        } catch (error) {
          resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
        }
      }

      testFix();
    </script>
  </body>
</html>
